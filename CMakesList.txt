cmake_minimum_required(VERSION 3.20)
project(LiquidChessEngine LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Performance flags
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -march=native -mtune=native")
set(CMAKE_CXX_FLAGS_RELEASE "-O3 -DNDEBUG -flto -funroll-loops")
set(CMAKE_CXX_FLAGS_DEBUG "-O0 -g -DDEBUG")

# Find Python and pybind11
find_package(Python3 COMPONENTS Development)
find_package(pybind11 REQUIRED)

# Main library
add_library(liquid_chess_core STATIC
    src/board/bitboard.cpp
    src/board/movegen.cpp
    src/board/magic.cpp
    src/search/search.cpp
    src/search/transposition.cpp
    src/search/parallel.cpp
    src/eval/nnue.cpp
    src/eval/material.cpp
    src/uci/uci.cpp
)

target_include_directories(liquid_chess_core PRIVATE include)
target_compile_options(liquid_chess_core PRIVATE
    -Wall -Wextra -Wpedantic
    -fno-exceptions -fno-rtti
    -mavx2 -mbmi2 -mpopcnt
)

# Python extension
pybind11_add_module(liquid_chess_cpp
    src/bridge/jax_bridge.cpp
    src/bridge/pybind_module.cpp
)

target_link_libraries(liquid_chess_cpp PRIVATE liquid_chess_core)

# Executable
add_executable(liquid_chess src/main.cpp)
target_link_libraries(liquid_chess PRIVATE liquid_chess_core)

# Tests
enable_testing()
add_executable(test_bitboard tests/test_bitboard.cpp)
target_link_libraries(test_bitboard PRIVATE liquid_chess_core)
add_test(NAME BitboardTest COMMAND test_bitboard)